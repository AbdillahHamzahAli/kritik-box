<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body id="feedback-flow">

    <div class="flow-card">

        <div class="flow-header">
            <div class="flow-title">
                <button id="backBtn" class="back-btn" style="display: none;" onclick="goToStep(1)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                </button>
                <span id="headerTitle">ğŸ‘‹ How's it going?</span>
            </div>
        </div>

        <div id="step1" class="step-container active">
            <p style="color: #6B7280; font-size: 0.9rem; margin-bottom: 20px;">
                Kami ingin mendengar pendapat Anda! Bagaimana pengalaman Anda di <strong><%= business.name %></strong>?
            </p>

            <div class="emoji-options">
                <button class="emoji-btn" onclick="selectRating(5, 'Fantastic!')">
                    <span class="emoji-icon">ğŸ˜</span>
                    <span class="emoji-label">Fantastic!</span>
                </button>
                <button class="emoji-btn" onclick="selectRating(4, 'Good.')">
                    <span class="emoji-icon">ğŸ™‚</span>
                    <span class="emoji-label">Good.</span>
                </button>
                <button class="emoji-btn" onclick="selectRating(3, 'Fine.')">
                    <span class="emoji-icon">ğŸ˜</span>
                    <span class="emoji-label">Fine.</span>
                </button>
                <button class="emoji-btn" onclick="selectRating(2, 'Not so great.')">
                    <span class="emoji-icon">ğŸ˜•</span>
                    <span class="emoji-label">Not so great.</span>
                </button>
                <button class="emoji-btn" onclick="selectRating(1, 'Improvements needed.')">
                    <span class="emoji-icon">ğŸ˜¡</span>
                    <span class="emoji-label">Improvements needed.</span>
                </button>
            </div>
        </div>

        <div id="step2" class="step-container">
            <p style="color: #6B7280; font-size: 0.9rem; margin-bottom: 12px;">
                Kami ingin mendengar dari Anda! Apa alasan Anda memilih <strong id="selectedRatingText">...</strong>?
            </p>

            <form id="feedbackForm" onsubmit="submitFeedback(event)">
                <input type="hidden" id="ratingValue">
                <input type="hidden" name="code" id="codeInput" value="<%= business.unique_code %>">
                <textarea id="commentInput" class="feedback-textarea-light" placeholder="Saya suka fitur ini..." required></textarea>
                <button type="submit" class=" btn btn-submit-flow">Submit</button>
            </form>
        </div>

        <div id="step3" class="step-container">
            <div class="success-illustration">
                <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ±âœ¨</div>

                <h2 style="font-size: 1.5rem; margin-bottom: 10px; color: #111;">Thank you! ğŸ’•</h2>
                <p style="color: #6B7280;">
                    Terima kasih telah mengirimkan feedback! Kami sangat menghargai waktu Anda.
                </p>
            </div>
        </div>

    </div>

    <script>
        let currentRating = 0;

        function selectRating(value, text) {
            currentRating = value;

            document.getElementById('ratingValue').value = value;

            document.getElementById('selectedRatingText').innerText = `"${text}"`;

            goToStep(2);
        }

        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));

            document.getElementById(`step${step}`).classList.add('active');

            const backBtn = document.getElementById('backBtn');
            const headerTitle = document.getElementById('headerTitle');

            if (step === 2) {
                backBtn.style.display = 'flex';
                headerTitle.innerText = "How's it going?";
            } else if (step === 1) {
                backBtn.style.display = 'none';
                headerTitle.innerText = "ğŸ‘‹ How's it going?";
            } else if (step === 3) {
                backBtn.style.display = 'none';
                headerTitle.innerText = "";
            }
        }

        async function submitFeedback(e) {
            e.preventDefault();

            const submitBtn = document.querySelector('.btn-submit-flow');
            submitBtn.innerText = "Mengirim...";
            submitBtn.disabled = true;

            const code = document.getElementById('codeInput').value;
            const data = {
                rating: document.getElementById('ratingValue').value,
                comment: document.getElementById('commentInput').value
            };

            try {
                const response = await fetch(`/feedback/${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    goToStep(3);
                } else {
                    alert('Gagal mengirim feedback.');
                    submitBtn.innerText = "Submit";
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan koneksi.');
                submitBtn.innerText = "Submit";
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
