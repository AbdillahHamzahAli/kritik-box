<!DOCTYPE html>
<html lang="id">
<%- include('../partials/header') %>

<body id="admin-dashboard">
    <div class="admin-wrapper">

        <%- include('../partials/sidebar', { page: 'dashboard' }) %>

        <main class="admin-content">

            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Overview kinerja feedback bisnis Anda.</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Total Feedback</div>
                        <div class="stat-value"><%= stats.total_feedbacks %></div>
                    </div>
                    <div class="stat-trend trend-up">
                        <span>Data Aktual</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div>
                        <div class="stat-label">Total Business</div>
                        <div class="stat-value"><%= stats.total_businesses %></div>
                    </div>
                    <div class="stat-trend">
                        <span style="color: var(--text-muted);">Cabang terdaftar</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div>
                        <div class="stat-label">Average Rating</div>
                        <div class="stat-value"><%= stats.average_rating %></div>
                    </div>
                    <div class="stat-trend trend-up">
                        <span style="color: var(--text-muted);">Rata-rata</span>
                    </div>
                </div>
            </div>


            <div class="chart-section">
                <div class="section-header">
                    <h2 class="section-title">Tren Feedback (7 Hari Terakhir)</h2>
                    <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;">Last 7 Days</button>
                </div>
                <div style="height: 300px; width: 100%;">
                    <canvas id="feedbackChart"></canvas>
                </div>
            </div>

            <div class="chart-section" style="margin-top: 24px;">
                <div class="section-header">
                    <h2 class="section-title">
                        Kata Kunci Populer
                        <% if (!stats.is_premium) { %>
                            <span style="font-size: 0.7rem; background: #FCD34D; color: #78350F; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 8px;">PRO</span>
                        <% } %>
                    </h2>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">Apa yang sering dibicarakan pelanggan?</p>
                </div>

                <% if (stats.is_premium) { %>
                    <div style="width: 100%; height: 350px; position: relative;">
                        <canvas id="wordCloudCanvas" style="width: 100%; height: 100%;"></canvas>
                    </div>

                <% } else { %>
                    <div class="premium-lock-container" style="width: 100%; height: 350px;">
                        <div class="premium-blur" style="width: 100%; height: 100%; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; overflow: hidden;">
                            <span style="font-size: 40px; color: #ddd; font-weight: bold;">Enak</span>
                            <span style="font-size: 20px; color: #eee; font-weight: bold;">Mahal</span>
                            <span style="font-size: 60px; color: #ccc; font-weight: bold;">Pelayanan</span>
                            <span style="font-size: 30px; color: #eee; font-weight: bold;">Bersih</span>
                            <span style="font-size: 50px; color: #ddd; font-weight: bold;">Kopi</span>
                            <span style="font-size: 25px; color: #eee; font-weight: bold;">Lama</span>
                        </div>
                        <div class="premium-overlay">
                            <div class="lock-icon-circle">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            </div>
                            <h3 class="premium-title">Analisa AI Terkunci</h3>
                            <p class="premium-desc">Upgrade ke Pro untuk melihat sentimen pelanggan dan kata kunci populer secara otomatis.</p>
                            <a href="/admin/settings" class="btn btn-primary" style="padding: 10px 24px; font-size: 0.9rem;">
                                Upgrade Sekarang
                            </a>
                        </div>
                    </div>
                <% } %>
            </div>

            <div class="recent-feedback-section">
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <h2 style="font-size: 1.1rem;">Feedback Terbaru</h2>
                </div>
                <table class="feedback-table">
                    <thead>
                        <tr>
                            <th>Nama Bisnis</th>
                            <th>Rating</th>
                            <th>Pesan</th>
                            <th>Lokasi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (reviews && reviews.length > 0) { %>
                            <% reviews.forEach(function(review) { %>
                            <tr>
                                <td><%= review.business_name %></td>
                                <td><span class="rating-badge"><%= review.rating %> â˜…</span></td>
                                <td style="color: var(--text-muted);"><%= review.text %></td>
                                <td><%= review.business_location || 'Pusat' %></td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="4" style="text-align:center;">Belum ada data.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('feedbackChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(17, 24, 39, 0.2)');
        gradient.addColorStop(1, 'rgba(17, 24, 39, 0)');
        const labelsFromAPI = <%- JSON.stringify(chartLabels) %>;
        const dataFromAPI = <%- JSON.stringify(chartValues) %>;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsFromAPI,
                datasets: [{
                    label: 'Feedback Masuk',
                    data: dataFromAPI,
                    borderColor: '#111827',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9CA3AF' }
                    },
                    y: {
                        beginAtZero: true,
                        border: { display: false },
                        grid: { color: '#F3F4F6' },
                        ticks: {
                            color: '#9CA3AF',
                            stepSize: 1
                        }
                    }
                }
            }
        });

        const rawReviews = <%- JSON.stringify(reviews) %>;

            const stopWords = [
                "dan", "yang", "di", "ke", "dari", "ini", "itu", "untuk", "pada",
                "dengan", "adalah", "saya", "aku", "kami", "kita", "mereka", "dia",
                "tapi", "tetapi", "namun", "juga", "sangat", "banget", "agak", "cukup",
                "karena", "seperti", "bisa", "ada", "tidak", "yg", "ga", "gak", "aja", "nya"
            ];

            function generateWordCloud() {
                let textContent = "";
                rawReviews.forEach(r => {
                    textContent += " " + (r.text || r.comment || "");
                });

                const words = textContent
                    .toLowerCase()
                    .replace(/[^\w\s]/gi, '')
                    .split(/\s+/);

                const wordCounts = {};
                words.forEach(word => {
                    if (word.length > 2 && !stopWords.includes(word)) {
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    }
                });

                let cloudData = [];
                for (let word in wordCounts) {
                    cloudData.push([word, wordCounts[word] * 10]);
                }

                cloudData.sort((a, b) => b[1] - a[1]);

                const canvas = document.getElementById('wordCloudCanvas');

                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;

                WordCloud(canvas, {
                    list: cloudData,
                    gridSize: 10,
                    weightFactor: function (size) {
                        return Math.max(16, (size * 2));
                    },
                    fontFamily: 'Plus Jakarta Sans, sans-serif',
                    color: function (word, weight) {
                        const colors = ['#111827', '#2563EB', '#059669', '#D97706', '#4B5563'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0,
                    backgroundColor: '#ffffff'
                });
            }

            setTimeout(generateWordCloud, 500);
            window.addEventListener('resize', () => {
                setTimeout(generateWordCloud, 200);
            });
    </script>
</body>
</html>
